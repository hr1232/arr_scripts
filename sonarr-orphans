#!/bin/bash

SETTINGS="/etc/arr_scripts"
if [ ! -f "${SETTINGS}" ]; then
  echo "❎ Settings-Datei nicht lesbar: ${SETTINGS}"
  exit 1
else
  source "${SETTINGS}"
fi

# API Basis-URL
BASE_URL="http://${SONARR_IP}:${SONARR_PORT}/api/v3"

# API Call zu Sonarr
sonarr_api() {
    local endpoint="$1"
    curl -s -H "X-Api-Key: $SONARR_APIKEY" "http://$SONARR_IP:$SONARR_PORT/api/v3/$endpoint"
}

# Prüfen, ob Datei eine Metadaten-Datei ist
is_metadata_file() {
    local filename="$1"
    case "$filename" in
        banner.jpg|clearlogo.png|fanart.jpg|poster.jpg|tvshow.nfo) return 0 ;;
        season*-banner.jpg|season*-poster.jpg|season-specials-banner.jpg|season-specials-poster.jpg) return 0 ;;
        *) return 1 ;;
    esac
}

# serien-JSON abrufen
series_json=$(sonarr_api "series")

echo "$series_json" | jq -c '.[]' | while read -r serie; do

  series_path=$(echo "$serie" | jq -r '.path')
  if [ ! -d "$series_path" ]; then
      continue
  fi

  series_title=$(echo "$serie" | jq -r '.title')
  series_id=$(echo "$serie" | jq -r '.id')

  known_files=$(sonarr_api "episodefile?seriesId=$series_id" | jq -r '.[].relativePath')
  orphan_files=()

  while IFS= read -r file; do
        filename=$(basename "$file")

        # Metadaten-Dateien überspringen
        if is_metadata_file "$filename"; then
            continue
        fi

        # Prüfen, ob die Datei bekannt ist
        if ! echo "$known_files" | grep -Fxq "$filename"; then
            orphan_files+=("$filename")
        fi
    done < <(find "$series_path" -type f)

    if [ ${#orphan_files[@]} -gt 0 ]; then
        echo "$series_title:"
        for f in "${orphan_files[@]}"; do
            echo "    - $f"
        done
    fi

done
